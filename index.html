import express from 'express';
import cors from 'cors';
import axios from 'axios';
import dotenv from 'dotenv';
dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

// Dummy email function: replace with your real email sending code!
async function sendEmail(name, email, phone, product, method) {
  console.log('Sending email with info:', { name, email, phone, product, method });
  // TODO: Implement real email sending with nodemailer or any service.
}

app.post('/api/checkout', async (req, res) => {
  const { name, email, phone, product, price, method } = req.body;
  console.log('Received checkout request:', req.body);
  console.log('NowPayments API Key:', process.env.NOWPAYMENTS_API_KEY ? 'Exists' : 'Missing');

  if (!name || !email || !phone || !product || !price || !method) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  try {
    await sendEmail(name, email, phone, product, method);

    if (method === 'crypto') {
      const response = await axios.post(
        'https://api.nowpayments.io/v1/invoice',
        {
          price_amount: Number(price),
          price_currency: 'usd',
          pay_currency: 'btc',
          order_id: product,
          order_description: `Order for ${product}`,
          success_url: 'http://localhost:3000/success.html',
          cancel_url: 'http://localhost:3000/cancel.html',
        },
        {
          headers: {
            'x-api-key': process.env.NOWPAYMENTS_API_KEY,
            'Content-Type': 'application/json',
          },
        }
      );

      console.log('NowPayments invoice response:', response.data);
      return res.json({ url: response.data.invoice_url });
    } else if (method === 'card') {
      // Gardarian URL for card payments via NowPayments partner
      const gardarianUrl = `https://widget.gardarian.com/payment?amount=${Number(
        price
      )}&fiat_type=usd&crypto=btc&email=${encodeURIComponent(email)}`;
      console.log('Card payment URL:', gardarianUrl);
      return res.json({ url: gardarianUrl });
    }

    res.status(400).json({ error: 'Invalid payment method' });
  } catch (err) {
    console.error('Error in /api/checkout:', err);
    if (err.response) {
      console.error('NowPayments API error data:', err.response.data);
    }
    res.status(500).json({ error: 'Payment error' });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`âœ… Server running on http://localhost:${PORT}`);
});

